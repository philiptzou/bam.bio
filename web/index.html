<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="A playground for running the samtools genomics utility in the browser using WebAssembly.">
    <meta name="author" content="Robert Aboukhalil">

    <title>bam.bio</title>

    <!-- Bootstrap core CSS -->
    <link href="node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="node_modules/handsontable/dist/handsontable.full.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="dashboard.css" rel="stylesheet">
  </head>

  <body>
    <nav class="navbar navbar-dark sticky-top bg-primary flex-md-nowrap p-0">
      <a class="navbar-brand text-center bg-primary col-sm-1 col-md-1 mr-0" href="/">bam.bio</a>
      <ul class="navbar-nav px-3">
        <li class="nav-item text-nowrap">
          <a class="nav-link" href="https://github.com/robertaboukhalil/bam.bio">About</a>
        </li>
      </ul>
    </nav>

    <div class="container-fluid">
      <div class="row">
        <main role="main" class="col-md-12 ml-sm-auto pt-3 px-4">
          <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
            <div class="btn-toolbar mb-2 mb-md-0">
              <h4>Samtools Playground</h4>
              <input type="file" id="file" class="d-none" multiple />
              <button id="btn-example" type="button" class="btn btn-sm btn-primary" style="margin-left:20px">
                Load sample .bam
              </button>    
              <div class="btn-group" style="margin-left:10px">
                <button id="btn-upload" type="button" class="btn btn-sm btn-outline-secondary">
                  Load .bam from my computer
                </button>
                <div id="file-local" class="input-group-append d-none">
                  <div class="input-group-text">
                    <span class="text-muted"><small>Mounted as &nbsp;</small></span>
                    <input id="file-local-path" type="text" value="" class="form-control form-control-sm p-0 text-danger">
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="app" class="row">
              <div class="col-11">
                <div class="row col-12">
                  <div class="input-group mb-3">
                    <input id="query" type="text" class="form-control" placeholder="Enter a samtools command, e.g. samtools --help" value="samtools --help" autofocus>
                    <div class="input-group-append">
                      <button class="btn btn-primary">Run</button>
                      <button class="btn btn-outline-primary dropdown-toggle"  data-toggle="dropdown">Sample queries</button>
                      <div class="dropdown-menu">
                        <h6 class="dropdown-header">Help Screen</h6>
                        <a class="dropdown-item samtool-query" href="#" data-command="samtools --help">&nbsp;&nbsp;<code>samtools --help</code></a>
                        <h6 class="dropdown-header">BAM Stats</h6>
                        <a class="dropdown-item samtool-query" href="#" data-command="samtools idxstats /urls/A549_CDKN2A.bam">&nbsp;&nbsp;<code>samtools idxstats</code></a>
                        <a class="dropdown-item samtool-query" href="#" data-command="samtools view -H /urls/A549_CDKN2A.bam">&nbsp;&nbsp;<code>samtools view -H</code></a>
                        <a class="dropdown-item samtool-query" href="#" data-command="samtools view -c /urls/A549_CDKN2A.bam 9:21,967,752-21,995,324">&nbsp;&nbsp;<code>samtools view -c</code></a>
                        <h6 class="dropdown-header">Filtering</h6>
                        <a id="samtool-query-default" class="dropdown-item samtool-query" href="#" data-command="samtools view /urls/A549_CDKN2A.bam 9:21,967,752-21,995,324">&nbsp;&nbsp;<code>samtools view</code></a>
                        <a class="dropdown-item samtool-query" href="#" data-command="samtools view -q 10 /urls/A549_CDKN2A.bam 9:21,967,752-21,995,324">&nbsp;&nbsp;<code>samtools view -q 20</code></a>
                        <a class="dropdown-item samtool-query" href="#" data-command="samtools view -F 2 /urls/A549_CDKN2A.bam 9:21,967,752-21,995,324">&nbsp;&nbsp;<code>samtools view -F 2</code></a>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="row col-12">
                  <small class="text-muted" style="margin-top:-10px">
                    <span id="error"></span>
                    <br /><br />
                  </small>
                </div>
              </div>
              <div class="col-1 text-center">
                <input id="rows" class="form-control text-center" type="text" value="100">
                <small class="text-muted">
                  <span>Max rows</span>
                </small>
              </div>
          </div>
          <div class="row">
              <div class="col-12">
                <div id="data" style="width:100%; height:55vh; overflow-y:scroll"></div>
              </div>

              <div class="col-12">
                <div class="dropdown float-right">
                  <button id="btn-export" type="button" class="btn btn-sm btn-outline-secondary" disable>
                    Export as SAM
                  </button>
                </div> 
              </div> 
          </div>
        </main>
      </div>
    </div>
    <br />

    <script src="node_modules/jquery/dist/jquery.slim.min.js"></script>
    <script src="node_modules/popper.js/dist/umd/popper.min.js"></script>
    <script src="node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="node_modules/handsontable/dist/handsontable.full.min.js"></script>
    <script src="node_modules/@robertaboukhalil/aioli/aioli.js"></script>
    <script>
    var app = null, table = null, debug = true;
    var DIR_SAMPLE_BAM_PREFIX = debug ? "../../../" : "";
    var DIR_IMPORTS = [ "samtools.worker.js" ];
    var DIR_SAMPLE_BAM = [
      `${DIR_SAMPLE_BAM_PREFIX}data/A549_CDKN2A.bam`,
      `${DIR_SAMPLE_BAM_PREFIX}data/A549_CDKN2A.bam.bai`
    ];


    // =========================================================================
    // Main class
    // =========================================================================
    class App
    {
      // -----------------------------------------------------------------------
      // Initialization + WebAssembly
      // -----------------------------------------------------------------------

      constructor() {
        this.aioli = null;
        this.maxRows = 100;
        this.cmd = "";
        this.init();
      }

      init() {
        this.loading();

        // Create Aioli (and the WebWorker in which Wasm code will run)
        this.aioli = new Aioli({ imports: DIR_IMPORTS });

        // Initialize Wasm within WebWorker + mount sample BAMs
        return this.aioli
          .init()
          .then(() => this.mount(DIR_SAMPLE_BAM))
          .then(() => this.query("samtools --help"))
          .then(() => this.loaded());
      }

      exec(cmdStr) {
        return this.aioli.exec({
          raw: true,
          args: cmdStr.split(" ").slice(1),  // remove 1st command (i.e. samtools)
        });
      }


      // -----------------------------------------------------------------------
      // Utility functions for UI
      // -----------------------------------------------------------------------

      log(msg) {
        console.log(msg);
      }

      statusQuery(query) {
        $("#query").val(query);
      }

      statusMount(bamFilePath) {
        $("#file-local").removeClass("d-none");
        $("#file-local-path").val(bamFilePath);
        $("#file-local-path").css("width", `${bamFilePath.length + 3}ch`);
      }

      error(msg) {
        $("#error").removeClass("text-danger");
        if(msg == null)
          msg = "Enter a samtools query and press Enter";
        else
          $("#error").addClass("text-danger");
        $("#error").html(msg);
      }

      loading() {
        $("#app, #data").css("opacity", 0.4);
        $("#btn-run, #btn-export, #btn-example, #btn-upload").attr("disabled", true);
      }

      loaded() {
        $(".colHeader").hide();  // don't show default headers A, B, ...
        $("#app, #data").css("opacity", 1);
        $("#btn-run, #btn-export, #btn-example, #btn-upload").attr("disabled", false);
      }

      // -----------------------------------------------------------------------
      // File management
      // -----------------------------------------------------------------------

      isURL(obj) {
        return typeof(obj) == "string" && (!obj.startsWith("/") || obj.startsWith("http://") || obj.startsWith("https://"));
      }

      data(d=[""]) {
        table.loadData(d);
      }

      mount(files) {
        // Infer which file is .bam, which is .bai
        var bamFile = null, baiFile = null;
        for(var f of files) {
          var fname = this.isURL(f) ? f : f.name;
          var ext = fname.split('.').pop();
          if(ext == "bam")
            bamFile = f;
          if(ext == "bai")
            baiFile = f;
        }
        if(files.length != 2 || bamFile == null || baiFile == null) {
          alert("Invalid input: Please select two files: a .bam file and a .bam.bai file");
          return;
        }

        var config = {};
        var isURL = this.isURL(bamFile) && this.isURL(baiFile);
        config[isURL ? "urls" : "files"] = [bamFile, baiFile];

        // Mount files or URLs
        return this.aioli.mount(config).then(mounted => {
          this.log("Mounted:", mounted);
          if(isURL)
            return;

          // If user provided their own .bam file, run simple command on it
          var bamFilePath = mounted[bamFile.name].path;
          this.statusMount(bamFilePath);
          return this.query(`samtools view -H ${bamFilePath}`);
        });
      }

      query(query) {
        query = query || this.cmd;
        this.loading();
        this.statusQuery(query);
        this.exec(query).then(out => {
          this.error();
          // On error:
          if(out.stderr != null) {
            console.warn(out.stderr);
            this.data(out.stderr.map(d => [d]));
            this.error(out.stderr[0]);
            this.loaded();
            return;
          }
          // If have output to display, split by tab and limit nb rows
          if(out.stdout != null) {
            this.data(
              out.stdout
                 .slice(0, this.maxRows)
                 .map(d => d.split("\t"))
            );
          } else {
            this.data();
          }

          this.loaded();
        });
      }
    }


    // =========================================================================
    // Button behavior
    // =========================================================================

    // Detect choosing file from computer
    $("#btn-run").on("click", () => app.query());
    $("#btn-upload").on("click", () => $("#file").trigger("click"));
    $("#file").change(function(){ app.mount(this.files) });

    // User inputs
    $("#query, #rows").on("keyup", e => {
      app.cmd = $("#query").val();
      app.maxRows = Number($("#rows").val());
      if(e.keyCode == 13)
        app.query();
    });

    // Sample queries
    $("#btn-example").on("click", () => $("#samtool-query-default").click());
    $(".samtool-query").on("click", function(){ app.query($(this).attr("data-command")) });

    // Export as TSV
    $("#btn-export").on("click", () => {
      table.getPlugin("exportFile")
           .downloadFile("csv", {
             columnDelimiter: "\t",
             rowDelimiter: "\n",
             fileExtension: "sam",
             mimeType: "text/tab-separated-values",
             filename: "export-[YYYY]-[MM]-[DD]"
           });
    });

    // Make it easier to copy/paste the mounted file path
    $("#file-local-path").on("focus", function(){ this.select() });


    // =========================================================================
    // On page load
    // =========================================================================
    document.addEventListener("DOMContentLoaded", function() {
      // Setup data table
      table = new Handsontable(document.getElementById("data"), {
        data: [[""]], colHeaders: [""],
        rowHeights: 30, width: '100%', stretchH: 'all', className: "htMiddle",
        manualColumnResize: true, filters: true, contextMenu: [],
        dropdownMenu: ["filter_by_condition", "filter_operators", "filter_by_condition2", "filter_by_value", "filter_action_bar"],
        licenseKey: "non-commercial-and-evaluation"
      });
    });

    // Setup app
    app = new App();
    </script>
  </body>
</html>
